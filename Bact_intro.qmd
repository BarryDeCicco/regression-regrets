# Bacteremia study  {#Bacteremia}

```{r intro01, warning=FALSE, message=FALSE}
## Load libraries for this chapter
library(readr)
library(dplyr)
library(gt)
library(Hmisc)
library(skimr)
library(janitor)
library(here)
library(DT)
```


## Bacteremia study overview 

We will exemplify our proposed systematic approach to data screening by means of a diagnostic study with the primary aim of using age, sex and 49 laboratory variables to fit a diagnostic prediction model for the bacteremia status (= presence of bacteria in the blood stream) of a blood sample. A secondary aim of the study is to describe the functional form of each predictor in the model. Between January 2006 and December 2010, patients with the clinical suspicion to suffer from bacteremia were included if blood culture analysis was requested by the responsible physician and blood was sampled for assessment of hematology and biochemistry. An analysis of this study can be found in @Ratzinger2014.

The data consists of 14,691 observations from different patients and 51 potential predictors. To protect data privacy our version of this data was slightly modified compared to the original version, and this modified version was cleared by the Medical University of Vienna for public use (**DC 2019-0054**). Compared to the official results given in [@Ratzinger2014], our results may differ to a negligible degree. 


## Source dataset

### Where to access the data

We refer to the **source** data as the raw data set available in this repository (**DC 2019-0054**). The data set is published on [Zenodo](https://doi.org/10.5281/zenodo.7554815) with the following doi: https://doi.org/10.5281/zenodo.7554815. 

For simplicity, we have also stored the *source* data and accompanying materials such as the **data dictionary** the `data-raw` directory. 

### Understanding the data

First, we read and display the data dictionary that was provided with the source data. We display the dictionary below providing an overview of the collected measurements. The `variable` name and `label` are displayed alongside the measurement `scale` and `units` as well as `remarks` and relevant study information `from_paper`. 

```{r datadict, warning=FALSE, message=FALSE, echo=FALSE}

## Read in the source data dictionary, 
## clean column names to be consistent format 
## and arrange by variable order.  

bact_dd <- read_csv(
  here("data-raw", "Bacteremia_public_S2_Data_Dictionary.csv")
  ) |>
  arrange(VariableNr) |>
  clean_names()
```

```{r datadict_display}

## display the dictionary. 

bact_dd |> 
  select(-variable_nr) |>
  gt()

```


### Overview of the measurements

We also read the source data set from the `data-raw` folder of the project directory. 

```{r contents_bact,  warning=FALSE, message=FALSE, echo=FALSE} 

## Load the source dataset from the data folder. 
bact <- read_csv(
  here("data-raw", "Bacteremia_public_S2.csv")
  ) 

```

We do not display all observations measured in the the `source data` as it is too wide and long to fit reasonably in to the report. Below is a glimpse of the data set to provide more context of its structure. We refer you to the [Zenodo page](https://doi.org/10.5281/zenodo.7554815) for an interactive overview of the source data. 

```{r contents_bact_glimpse,  warning=FALSE, message=FALSE, echo=FALSE}
# TODO:: Move to appendix?
bact |> glimpse(width = getOption("width"))
```


## Analysis ready dataset

The aim of this section and the remaining chapters of the report are to document the steps taken towards transforming the *source* data set to an *analysis ready* data set.


In this section, additional meta-data is added to the *source* data set. 

We write this new modified (annotated) data set back to the `data` folder after adding additional meta-data for all variables. The meta-data is taken from the data dictionary. The aim is to produce an analysis ready data set for the research objective. 

At the stage we could select the variables of interest to take in to the IDA phase by dropping variables we do not check in IDA.


```{r contents_abact, warning=FALSE, message=FALSE, echo=FALSE} 

## Generate a derived dataset stored in data as we are adding to the original source dataset obtained. 

# make copy of bact for analysis data set without metadata levels. 
a_bact_01 <- bact

## Derive outcome variable. ACTION: We add this to the data dictionary as a derived variable
a_bact_01$BC <- as.numeric(a_bact_01$BloodCulture=="yes")+0

```


```{r meta, warning=FALSE, message=FALSE, echo=FALSE}
## Complete metadata by adding missing labels. 
## Generate a derived dataset stored in data as we are adding to the original source dataset obtained. 
## Add meta data for derived data

labels_list <- c(bact_dd$label, "bacteremia")
units_list <- c(bact_dd$units, "0/1")
names(labels_list) <- names(units_list) <- c(bact_dd$variable, "BC")

## Complete metadata by adding missing labels.
a_bact_01_md <- Hmisc::upData(
  a_bact_01,
  labels = labels_list[names(a_bact_01)], units=units_list[names(a_bact_01)])
```


As a cross check we display the contents again to ensure the additional data is added, and then write  the changes to the data folder in the file **"data/a_bact_01.rda"**. 

Note that a copy of the analysis data **a_bact_01_md** with metadata labels and without **a_bact_01** are stored.  

```{r savds, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
## Check the contents of the updated data set and save to the *data* folder.  

## Display contents
Hmisc::html(Hmisc::contents(a_bact_01_md),
            maxlevels = 10,
            levelType = 'table')

## Write to data folder both data with and without meta-data
save(list=c("a_bact_01", "a_bact_01_md"), file = here::here("data", "a_bact_01.rda"))

```



## References 
