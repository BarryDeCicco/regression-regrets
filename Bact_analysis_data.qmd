# Analysis ready data {#ARD}


```{r intro01, warning=FALSE, message=FALSE}
## Load libraries for this chapter
library(readr)
library(dplyr)
library(gt)
library(Hmisc)
library(skimr)
library(janitor)
library(here)
library(DT)
```


Based on the IDA plan prepare the data to be analysis ready. 


## Analysis ready dataset

The aim of this section and the remaining chapters of the report are to document the steps taken towards transforming the *source* data set to an *analysis ready* data set.


In this section, additional meta-data is added to the *source* data set. 

We write this new modified (annotated) data set back to the `data` folder after adding additional meta-data for all variables. The meta-data is taken from the data dictionary. The aim is to produce an analysis ready data set for the research objective. 

At the stage we could select the variables of interest to take in to the IDA phase by dropping variables we do not check in IDA.


```{r contents_abact, warning=FALSE, message=FALSE, echo=FALSE} 

library(readr)
library(dplyr)
library(janitor)
library(here)
library(DT)
library(tidyr)
library(ggplot2)
library(tidyselect)

## Read in the source data dictionary and display 
bact_dd <- read_csv(here("data-raw", "Bacteremia_public_S2_Data_Dictionary.csv")) %>%
  arrange(VariableNr) |>
  clean_names() |>
  mutate(PARAMCD = variable )

bact_dd |> glimpse()

## display as a table 
#bact_dd |> 
#  datatable(options = list(pageLength = 5))


## Read in the source data 
bact_data <- read_csv(here("data-raw", "Bacteremia_public_S2.csv")) 

bact_data %>% spec()



## transform 
bact_data01 <-
  bact_data |> 
  pivot_longer(
    cols = c(-ID, -SEX, -AGE, -BloodCulture),
    names_to = "PARAMCD",
    #names_prefix = "PARAMCD",
    values_to = "AVAL",
    values_drop_na = FALSE
)


bact_data02 <- 
  bact_data01 |> 
  left_join(bact_dd, by = "PARAMCD") |>
  mutate(
    UNIT = units,
    TYPE = if_else(scale_of_measurement == "continuous", "numeric", "NA"), 
    NOTE = remark, 
    NOTE2 = from_paper,
    SEXC = case_when(
      SEX == 1 ~ "male",
      SEX == 2 ~ "female",
      TRUE ~ "NA"
    ),
    SUBJID = ID + 100000, 
    USUBJID = paste0("DC-2019-0054-", SUBJID),
    PARAM = paste0(label, " (", UNIT, ")"),
    BACTEREMIA = BloodCulture,
    BACTEREMIAN = case_when(
      BloodCulture == "no" ~ 0,
      BloodCulture == "yes" ~ 1)
  )


bact_data02 |> glimpse()

# Should come from the data set specification
bact_data03 <- 
  bact_data02 %>%
  relocate(USUBJID, SUBJID, AGE, SEX, SEXC, BACTEREMIA, BACTEREMIAN, PARAM, PARAMCD, AVAL, UNIT, TYPE, NOTE, NOTE2) |>
  select(USUBJID, SUBJID, AGE, SEX, SEXC, BACTEREMIA, BACTEREMIAN, PARAM, PARAMCD, AVAL, UNIT, TYPE, NOTE, NOTE2)



bact_data03 |> glimpse()

names(bact_data03)

## Takes me up to end of BACT_INTRO

attr(bact_data03$SUBJID, "label") <- "Patient Identifer"  
attr(bact_data03$USUBJID, "label") <- "Unique Patient Identifer with data souce reference: DC 2019-0054"  
attr(bact_data03$SEX, "label") <- "Patient gender"  
attr(bact_data03$SEX, "label") <- "Patient gender (Numeric coding, 1: male, 2: female)"  
attr(bact_data03$SEXC, "label") <- "Patient gender (Character coding)"  
attr(bact_data03$AGE, "label") <- "Patient age (years)"
attr(bact_data03$BACTEREMIA, "label") <- "Blood culture result for bacteremia (Character coding)"
attr(bact_data03$BACTEREMIAN, "label") <- "Blood culture result for bacteremia (Numeric coding, 0: No, 1: Yes)"
attr(bact_data03$PARAM, "label") <- "Parameter name"
attr(bact_data03$PARAMCD, "label") <- "Parameter code"
attr(bact_data03$AVAL, "label") <- "Parameter analysis value (Numeric)"
attr(bact_data03$UNIT, "label") <- "Parameter unit"
attr(bact_data03$TYPE, "label") <- "Parameter: variable type (Numeric, Character)"
attr(bact_data03$NOTE, "label") <- "Notes from source data dictionary - free text"
attr(bact_data03$NOTE2, "label") <- "Remarks from source data dictionary - free text"


table(bact_data02$BloodCulture)
table(bact_data03$BACTEREMIA)


bact_data03 %>% glimpse()


#### IDA PLAN

# age (AGE), leukocytes (WBC), blood urea neutrogen (BUN), creatinine (CREA), 
# thrombocytes (PLT), and neutrophiles (NEU) and these predictors will be included in the model as key predictors

# Predictors of medium importance are potassium (POTASS), 
# and some acute-phase related parameters such as fibrinogen (FIB), 
# C-reactive protein (CRP), aspartate transaminase (ASAT), 
# alanine transaminase (ALAT), and gamma-glutamyl transpeptidase (GGT).


bact_data04 <-
  bact_data03 |>
  mutate(
    KEY_PRED_FL = case_when(
      PARAMCD %in% c("WBC", "BUN", "CREA", "PLT", "NEU") ~ "Y"
      ),
    MED_PRED_FL = case_when(
      PARAMCD %in% c("POTASS", "FIB", "CRP", "ASAT", "ALAT", "GGT") ~ "Y"
      )
  )

attr(bact_data04$KEY_PRED_FL, "label") <- "Key Predictor Flag"
attr(bact_data04$MED_PRED_FL, "label") <- "Predictors of medium importance Flag"

bact_data04 |> glimpse()

## DO something with this? ###############

# For example, leukocytes consist of five different types of blood cells 
# (BASO, EOS, NEU, LYM and MONO), and the sum of the concentration of these types 
# approximately (but not exactly) gives the leukocyte count, which is recorded 
# in the variable WBC. Moreover, these variables are given as absolute counts 
# and as percentages of the sum of the five variables, which creates some correlation. 
# Some laboratory variables differ by sex and age, but the special selection of patients 
# for this study (suspicion of bacteremia) may distort or alter the expected correlations with sex and age.

## Age group
# For the purpose of stratifying IDA results by age, 
# age will be categorized into the following 
# three groups: [16, 50], (50, 65], (65, 101].

bact_data05 <-
  bact_data04 |>
  mutate(AGEGR01 = case_when(AGE >= 16  & AGE <= 50 ~ 1,
                           AGE > 50 & AGE <= 65 ~ 2,
                           AGE > 65 & AGE <= 101 ~ 3),
         AGEGR01C = case_when(AGEGR01 == 1 ~ "(16, 50]",
                              AGEGR01 == 2 ~ "(50, 65]",
                              AGEGR01 == 3 ~ "(65, 101]"))


attr(bact_data05$AGEGR01, "label") <- "Age group 01 (Numeric coding)"
attr(bact_data05$AGEGR01C, "label") <- "Age group 01 (Character coding)"

################### end of IDA plan

#-------------------- IDA missing ness

library(naniar)


ADSL <- bact_data05 %>%
  filter(PARAMCD == "WBC") %>%
  select(USUBJID, SUBJID, AGE, AGEGR01, AGEGR01C, SEX, SEXC, BACTEREMIA, BACTEREMIAN)


saveRDS(ADSL, file = "adsl.rds")


## keep age in ? as its a key predictor 
ADLB <- bact_data05 %>%
  select(-AGE, -AGEGR01, -AGEGR01C, -SEX, -SEXC, -BACTEREMIA, -BACTEREMIAN)

saveRDS(ADLB, file = "adlb.rds")



```



### check this section

As a cross check we display the contents again to ensure the additional data is added, and then write  the changes to the data folder in the file **"data/a_bact_01.rda"**. 

Note that a copy of the analysis data **a_bact_01_md** with metadata labels and without **a_bact_01** are stored.  

## to add in 

## Save data and meta data

Save the updated analysis results data including metadata to file. Also print out the current contents to check for possible errors. 


```
